name: Download Posts

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      disable_cache_check:
        description: 'Disable cache check (true/false)'
        required: false
        default: false
        type: boolean
      show_debug:
        description: 'Enable debug messages (true/false)'
        required: true
        default: true
        type: boolean
      post_limit:
        description: 'Number of posts to fetch from each subreddit'
        required: false
        default: '5'
        type: string
      target_posts:
        description: 'Number of posts to fetch per creator'
        required: false
        default: '50'
        type: string
      max_urls:
        description: 'Maximum total URLs to download'
        required: false
        default: '150'
        type: string
      creators:
        description: 'Comma-separated list of creators (leave empty for default)'
        required: false
        type: string
      delete_cache:
        description: 'Delete existing cache before starting'
        required: false
        default: false
        type: boolean

jobs:
  download-memes:
    name: 🌐 Download Memes
    runs-on: ubuntu-latest
    outputs:
      metadata: ${{ steps.collect-metadata.outputs.metadata }}
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 📦 Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 🧹 Remove Cache
        uses: DareFox/delete-cache-by-key@v1
        with:
          key: meme-ids-cache-
          mode: exact
        continue-on-error: true

      - name: 🚀 Restore Meme IDs Cache
        id: restore-cache
        uses: actions/cache@v4
        with:
          path: cache/meme_ids.json
          key: meme-ids-cache-
          restore-keys: |
            meme-ids-cache-
      - name: 🧰 Install Dependencies
        run: |
          echo "🟢 Upgrading pip..."
          python -m pip install --upgrade pip
          echo "🟢 Installing PRAW, Requests, and yt_dlp..."
          pip install praw requests yt-dlp
      - name: 🔧 Install Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.PIXELDRAIN_CONF }}
          disable_base64: true
      - name: ⏬ Download Reddit Posts
        id: download-memes
        run: |
          echo "🟢 Starting Meme download process..."
          python scripts/reddit_downloader.py \
            --client-id "${{ secrets.REDDIT_CLIENT_ID }}" \
            --client-secret "${{ secrets.REDDIT_CLIENT_SECRET }}" \
            --user-agent "Average Upvote v1.0 by /u/Hyphonical" \
            --post-limit "${{ inputs.post_limit || '5' }}" \
            $([ "${{ inputs.show_debug }}" == "true" ] && echo "--debug") \
            $([ "${{ inputs.disable_cache_check }}" == "true" ] && echo "--disable-cache")
      - name: 🗂️ Collect Metadata
        id: collect-metadata
        run: |
          echo "🟢 Collecting metadata..."
          # Limit to first 250 memes to prevent matrix overflow
          limited_metadata=$(jq '.[:250]' cache/memes_metadata.json)
          metadata=$(echo "$limited_metadata" | jq -c .)
          echo "metadata=$metadata" >> $GITHUB_OUTPUT
          echo "🟢 Metadata collection complete."
      - name: 🌐 Upload Memes with Rclone
        run: |
          echo "🟢 Uploading memes to Pixeldrain with Rclone..."
          rclone copy cache Pixeldrain:"💯 Memes" --disable-http2 --multi-thread-streams 6 --transfers 8 -v
          echo "🟢 Upload complete."
      - name: 🔧 Compute Hash of Updated meme_ids.json
        id: compute-hash
        run: |
          echo "🟢 Computing hash of meme_ids.json..."
          if [ -f cache/meme_ids.json ]; then
            FILE_HASH=$(sha256sum cache/meme_ids.json | awk '{print $1}')
            echo "🟢 Computed hash: $FILE_HASH"
          else
            FILE_HASH="empty-cache"
            echo "🔴 meme_ids.json not found. Using default hash."
          fi
          echo "hash=$FILE_HASH" >> $GITHUB_ENV
      - name: 💾 Update Meme IDs Cache
        uses: actions/cache@v4
        with:
          path: cache/meme_ids.json
          key: meme-ids-cache-${{ env.hash }}

      - name: 📜 List All Files
        run: |
          echo "🟢 Listing all files in cache..."
          tree
          echo "🟢 File listing complete."
      - name: 📤 Upload Cache as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: meme-cache
          path: cache/

  download-coomer:
    name: 🌐 Download Coomer
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 📦 Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: 🧹 Remove Cache
        uses: DareFox/delete-cache-by-key@v1
        with:
          key: coomer-ids-cache-
          mode: exact
        continue-on-error: true

      - name: 🚀 Restore Coomer IDs Cache
        id: restore-coomer-cache
        uses: actions/cache@v4
        with:
          path: cache/coomer_ids.json
          key: coomer-ids-cache-
          restore-keys: |
            coomer-ids-cache-
      - name: 🧰 Install Dependencies
        run: |
          echo "🟢 Installing dependencies..."
          python -m pip install --upgrade pip
          pip install requests
      - name: 🔧 Install Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.PIXELDRAIN_CONF }}
          disable_base64: true
      - name: ⏬ Download Coomer Posts (Parallel)
        run: |
          python scripts/coomer_downloader.py \
            $([ "${{ inputs.show_debug }}" == "true" ] && echo "--debug") \
            $([ "${{ inputs.disable_cache_check }}" == "true" ] && echo "--disable-cache") \
            --target-posts "${{ inputs.target_posts || '50' }}" \
            --max-urls "${{ inputs.max_urls || '150' }}" \
            $([ ! -z "${{ inputs.creators }}" ] && echo "--creators '${{ inputs.creators }}'") \
            $([ "${{ inputs.delete_cache }}" == "true" ] && echo "--delete-cache")
      - name: 🌐 Upload Coomer Posts with Rclone
        run: |
          echo "🟢 Uploading coomer posts to Pixeldrain with Rclone..."
          rclone copy cache Pixeldrain:"🌀 Onlyfans" --disable-http2 --multi-thread-streams 6 --transfers 8 -v
          echo "🟢 Upload complete."
      - name: 🔧 Compute Hash of Updated coomer_ids.json
        id: compute-hash-coomer
        run: |
          echo "🟢 Computing hash of coomer_ids.json..."
          if [ -f cache/coomer_ids.json ]; then 
            COOMER_HASH=$(sha256sum cache/coomer_ids.json | awk '{print $1}')
            echo "🟢 Computed hash: $COOMER_HASH"
          else
            COOMER_HASH="empty-cache"
            echo "🔴 coomer_ids.json not found. Using default hash."
          fi
          echo "coomer_hash=$COOMER_HASH" >> $GITHUB_ENV
      - name: 💾 Update Coomer IDs Cache
        uses: actions/cache@v4
        with:
          path: cache/coomer_ids.json
          key: coomer-ids-cache-${{ env.coomer_hash }}

      - name: 📜 List All Coomer Files
        run: |
          echo "🟢 Listing Coomer files in cache..."
          tree cache
          echo "🟢 File listing complete."

  send-to-telegram:
    needs: download-memes
    name: 📤 Send All Memes to Telegram
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Check Out Repository
        uses: actions/checkout@v4

      - name: 📤 Download Cache Artifact
        uses: actions/download-artifact@v4
        with:
          name: meme-cache
          path: cache/

      - name: 📦 Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 🧰 Install Python Dependencies
        run: |
          echo "🟢 Installing python-telegram-bot..."
          pip install python-telegram-bot
          echo "🟢 Python dependencies installed."
      - name: 📤 Send Memes to Telegram
        run: |
          echo "📤 Starting to send memes to Telegram..."
          python scripts/telegram_sender.py \
            --token "${{ secrets.TELEGRAM_TOKEN }}" \
            --chat-id "${{ secrets.TELEGRAM_TO }}" \
            $([ "${{ inputs.show_debug }}" == "true" ] && echo "--debug")
        continue-on-error: true
